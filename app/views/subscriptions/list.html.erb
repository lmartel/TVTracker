<%- model_class = Subscription -%>
<div class="page-header">
  <h1>
    <%#=t '.title', :default => model_class.model_name.human.pluralize %>
    <%=t '.title', :default => "You're watching:" %>
  </h1>
</div>
<div class="subscription-list">
  <% if @subscriptions.empty? %>
  <h2>Nothing! <%= link_to "Start tracking a show.", shows_path %></h2>
  <% else %>
    <% @subscriptions.each do |subscription| %>
      <div class="subscription-box" id="subscription-box<%= subscription.id %>">
        <%= render :partial => "list_item", :locals => { :subscription => subscription } %>
      </div>
    <% end %>
  <% end %>
</div>

<script type="text/javascript">
var hoverBox = function(event){
  var box = $(this).closest(".subscription-box");
  var thumb = box.find(".subscription-thumbnail");

  //save old thumbnail to restore after hover
  var FILENAME = "assets/check_medium.png";
  if(thumb.attr("src") !== FILENAME) thumb.attr("data-src", thumb.attr("src"));
  thumb.attr("src", FILENAME);

  box.children().css("background", "#015b4e none");
  box.find(".watch-next").css("color", "#aaa");
};
var unhoverBox = function(event){
  var box = $(this).closest(".subscription-box");
  var thumb = box.find(".subscription-thumbnail");
  thumb.attr("src", thumb.attr("data-src"));
  box.children().css("background", "");
  box.find(".watch-next").css("color", "");
};
$(document).on("mouseenter", ".subscription-box", hoverBox);
$(document).on("mouseleave", ".subscription-box", unhoverBox);
$(document).on("mouseenter", ".subscription-rewind", unhoverBox);
$(document).on("mouseleave", ".subscription-rewind", hoverBox);
$(document).on("click", ".subscription", function(event) {
  var sid = parseInt(this.id.split("subscription")[1]);
  $.ajax({
    type: "POST",
    url: "<%= watch_path(':id') %>".replace(":id", sid),
    datatype: "html",
    error: function(result){
      alert("error doe");
    },
    success: function(result){
      $("#subscription-box" + sid).append(result); 
      oldPanel = $("#subscription-box" + sid + " > div:first");
      newPanel = $("#subscription-box" + sid + " > div:last");
      newPanel.css("left", "150%");
      oldPanel.animate({
        left: "-150%" //TODO: make this work for larger screens, ie make content pane scale up with screen size?
      }, 500, function() { 
        //remove all but last child div, so the callback works even with queued animations
        $("#subscription-box" + sid + " > div").slice(0, -1).remove();
      });
      newPanel.animate({
        left: "-=150%"
      }, 500);
    }
  });
});
$(document).on("click", ".subscription-rewind", function(event) {
  event.stopImmediatePropagation();
  var sid = parseInt($(this).closest(".subscription").attr("id").split("subscription")[1]);
  $.ajax({
    type: "POST",
    url: "<%= unwatch_path(':id') %>".replace(":id", sid),
    datatype: "html",
    success: function(result){
      $("#subscription-box" + sid).append(result);
      oldPanel = $("#subscription-box" + sid + " > div:first");
      newPanel = $("#subscription-box" + sid + " > div:last");
      newPanel.hide();
      oldPanel.fadeOut(500, function(){
        newPanel.fadeIn(500, function(){
          //remove all but last child div, so the callback works even with queued animations
          $("#subscription-box" + sid + " > div").slice(0, -1).remove();
        });
      });
    }
  });
});
</script>